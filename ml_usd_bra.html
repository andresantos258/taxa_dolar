<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Análise de Cotação USD/BRL</title>
</head>
<body>
<h1>Análise e Previsão de Cotação USD/BRL</h1>
<pre id="output"></pre>
<canvas id="chart" width="800" height="400"></canvas>

<script>
// Carregar JSON automaticamente ao abrir a página
window.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('taxa_dolar.json');
        if (!response.ok) {
            alert('Erro ao carregar o arquivo JSON');
            return;
        }

        const data = await response.json();
        if (data.length === 0) {
            alert('JSON vazio ou mal formatado.');
            return;
        }
/*
        // Padronizar os nomes dos campos e converter valores numéricos
        const processedData = data.map(row => ({
            data: row['Data'],
            ultimo: parseFloat(row['Ultimo'].replace(',', '.')),
            abertura: parseFloat(row['Abertura'].replace(',', '.')),
            maxima: parseFloat(row['Maxima'].replace(',', '.')),
            minima: parseFloat(row['Minima'].replace(',', '.')),
            variacao: parseFloat(row['Var%'].replace(',', '.').replace('%', ''))
        }));
*/
        const closingPrices = processedData.map(row => row.ultimo);
        if (closingPrices.some(isNaN)) {
            alert('Erro ao processar os preços de fechamento. Verifique o formato dos dados.');
            console.error("Dados processados:", processedData);
            return;
        }

        // Regressão Linear
        const { slope, intercept } = linearRegression(closingPrices);

        // Previsão com Média Móvel Simples
        const movingAverage = calculateMovingAverage(closingPrices, 5);

        // Classificação da Variação
        const classifications = classifyVariation(processedData);

        // Exibir Resultados
        let output = `Regressão Linear: y = ${slope.toFixed(4)}x + ${intercept.toFixed(4)}\n`;
        output += `Média Móvel (5 períodos): ${movingAverage.filter(v => v !== null).pop().toFixed(4)}\n`;
        output += `Classificação Última Variação: ${classifications[classifications.length - 1]}\n`;
        document.getElementById('output').textContent = output;

        // Plotar Gráfico
        plotChart(closingPrices, movingAverage);
    } catch (error) {
        console.error(error);
        alert('Erro ao processar o arquivo JSON.');
    }
});

// Regressão Linear
function linearRegression(data) {
    const n = data.length;
    const xSum = (n * (n - 1)) / 2;
    const ySum = data.reduce((a, b) => a + b, 0);
    const xySum = data.reduce((sum, y, x) => sum + x * y, 0);
    const xSquaredSum = (n * (n - 1) * (2 * n - 1)) / 6;

    const slope = (n * xySum - xSum * ySum) / (n * xSquaredSum - xSum * xSum);
    const intercept = (ySum - slope * xSum) / n;
    return { slope, intercept };
}

// Média Móvel Simples
function calculateMovingAverage(data, period) {
    return data.map((val, index, arr) => {
        if (index < period - 1) return null;
        const sum = arr.slice(index - period + 1, index + 1).reduce((a, b) => a + b, 0);
        return sum / period;
    });
}

// Classificação de Variação
function classifyVariation(data) {
    return data.map(row => {
        return row.variacao > 0 ? 'Positiva' : 'Negativa';
    });
}

// Plotar Gráfico
function plotChart(prices, movingAverage) {
    const ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: prices.map((_, i) => i + 1),
            datasets: [
                {
                    label: 'Preço de Fechamento',
                    data: prices,
                    borderColor: 'blue',
                    fill: false
                },
                {
                    label: 'Média Móvel (5 períodos)',
                    data: movingAverage,
                    borderColor: 'red',
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: 'Dias' } },
                y: { title: { display: true, text: 'Preço' } }
            }
        }
    });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
